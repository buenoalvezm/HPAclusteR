#' Compute and store distance matrix from PCA Results
#'
#' Calculates a distance matrix based on PCA scores stored in an `AnnDatR` object
#' and saves the result inside `AnnDatR$uns$distance`.  
#' By default, it uses the minimum number of components needed to explain >80% variance,
#' but this can be overridden with `n_comp`.
#'
#' @param AnnDatR A list-like object containing PCA results in `AnnDatR$uns[[pca_id]]`.
#' @param method A string specifying the distance method (passed to
#'   [factoextra::get_dist]).
#' @param n_comp Number of PCA components to use. If `NULL`, the smallest number
#'   of components explaining >80% variance is chosen.
#' @param id Optional identifier for storing the distance matrix. Defaults to `method`
#'   if not provided.
#' @param pca_id Name of the entry in `AnnDatR$uns` where PCA results are stored.
#'   Defaults to `"pca"`.
#'
#' @return The updated `AnnDatR` object with a distance matrix stored in
#'   `AnnDatR$uns$distance[[id]]`.
#' @export
#'
#' @examples
#' # Example structure mimicking AnnDatR
#' pca_mock <- list(
#'   scores = matrix(rnorm(50), nrow = 10),
#'   R2cum = seq(0.1, 1, length.out = 5)
#' )
#' AnnDatR <- list(uns = list(pca = pca_mock))
#'
#' AnnDatR <- calculate_distance(AnnDatR, method = "euclidean")
#' names(AnnDatR$uns$distance)

calculate_distance <- function(AnnDatR,
                         method,
                         n_comp = NULL,
                         id = NULL,
                         pca_id = "pca") {
  if (is.null(AnnDatR$uns[[pca_id]])) {
    stop("AnnDatR$uns$pca not found. Call calculate_pca() before using calculate_distance().")
  }

  pca_results <- AnnDatR$uns[[pca_id]]

  if (is.null(n_comp)) {
    n_comp <- which(pca_results@R2cum > 0.8)[1]
  }

  if (is.null(AnnDatR$uns$distance)) {
    AnnDatR$uns$distance <- list()
  }

  distance <- pca_results@scores[, 1:n_comp] %>%
    factoextra::get_dist(method = method)

  key <- if (!is.null(id)) id else method
  AnnDatR$uns$distance[[key]] <- distance

  return(AnnDatR)
}